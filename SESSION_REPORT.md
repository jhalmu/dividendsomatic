# Session Report — 2026-02-13 (LATE EVENING)

## Lynx 9A PDF Trade Extraction & Import

### Problem
The "dark ages" gap (2019-2024) in the sold positions database. IBKR broker transaction data only covered partial years, and 2020 was completely missing. Lynx/IBKR PDF files in `csv_data/archive/Lynx/` contained comprehensive trade data from Finnish Vero 9A tax forms.

### Approach
1. **PDF analysis** — Identified 3 document types: 9A (capital gains), 16B (dividends), Kustannusten yleiskatsaus (costs)
2. **Two extraction methods:**
   - **pikepdf widget annotations** — for editable PDF forms (2019, 2020, 2022-2024). Field names like `160;N` (stock name), `161;N` (qty), etc. Page 0 uses bare names, subsequent pages use parenthesized names with globally sequential slot numbers.
   - **pdftotext -layout** — for locked/flattened 2021 PDFs (`lukittu_*`). Pattern-matched stock blocks after "Ilmoitan puuttuvan luovutuksen." markers.
3. **Name→ticker mapping** — 553 mappings built from DB lookups (broker_transactions + sold_positions) plus manual map for 177 stocks
4. **Import task** — `mix import_lynx9a` with idempotent dedup (symbol + sale_date + purchase_date + purchase_price + quantity + source)

### Extracted Data

| Year | Trades | Account | Method |
|------|--------|---------|--------|
| 2019 | 122 | U2299935 | widgets |
| 2020 | 273 | U2299935 | widgets |
| 2021 | 3,949 | U7299935 + U2299935 | text (lukittu) |
| 2022 | 2,496 | U7299935 | widgets |
| 2023 | 87 | U7299935 | widgets |
| 2024 | 236 | U7299935 | widgets |
| **Total** | **7,163** | | |

### Imported Sold Positions

| Year | Positions | Symbols | P&L (EUR) |
|------|-----------|---------|-----------|
| 2019 | 120 | 32 | -6,832 |
| 2020 | 254 | 57 | -28,607 |
| 2021 | 1,928 | 144 | +39,414 |
| 2022 | 2,066 | 128 | -132,509 |
| 2023 | 78 | 22 | -4,056 |
| 2024 | 220 | 57 | -5,169 |
| **Total** | **4,666** | | **-137,759** |

Difference from 7,163 CSV rows: 3 invalid (zero-price derivatives), ~2,494 identical lots (same stock/dates/prices/qty deduplicated).

### Changes

| File | Change |
|------|--------|
| `lib/mix/tasks/import_lynx_9a.ex` | **New** — `mix import_lynx9a` task with 553 name→ticker mappings |
| `csv_data/archive/lynx_all_9a_trades.csv` | **New** — 7,163 extracted 9A trades (generated by Python script) |
| `/tmp/extract_all_9a_v3.py` | Python extraction script (pikepdf + pdftotext) |

### Database Impact

| Source | Before | After |
|--------|--------|-------|
| lynx_9a | 0 | 4,666 |
| ibkr | 977 | 977 |
| nordnet | 209 | 209 |
| nordnet_9a | 439 | 439 |
| **Total** | **1,625** | **6,291** |

### Key Discoveries
- **2020 completely missing** from DB — now filled (254 positions, net P&L: -28,607 EUR)
- **2019 very sparse** — expanded from 9 to 129 positions
- **9A lot-level granularity** — one IBKR sell of 1000 shares may appear as 10+ 9A entries (different purchase lots, FIFO)
- **16B dividend PDFs** were empty templates (no extractable data)
- **Total realized P&L** across all sources and years: -302,301 EUR

### Verification
- `mix test.all` — 426 tests, 0 failures
- 3 credo warnings (nesting depth — pre-existing + 1 new in import task)
- Import idempotent: re-running produces 0 new records
